{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow-md mt-10">

    <!-- Back button -->
    <a href="{% url 'main:show_main' %}" class="inline-block mb-4 px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">
        &larr; Back to Products
    </a>

    <!-- Thumbnail -->
    {% if product.thumbnail %}
    <img id="product-thumbnail" src="{{ product.thumbnail }}" alt="{{ product.name }}"
        class="w-full h-64 object-cover rounded mb-4">
    {% endif %}

    <!-- Name & Description -->
    <h2 id="product-name" class="text-3xl font-bold mb-2">{{ product.name }}</h2>
    <p id="product-description" class="text-gray-600 mb-4">{{ product.description|truncatechars:300 }}</p>

    <!-- Price -->
    <p id="product-price" class="text-xl font-bold text-blue-700 mb-4">Rp {{ product.price|intcomma }}</p>

    <!-- Other Details -->
    <p class="text-gray-700 mb-1">
        <span class="font-semibold">Brand:</span>
        <span id="product-brand">{{ product.brand|default:"-" }}</span>
    </p>
    <p class="text-gray-700 mb-1">
        <span class="font-semibold">Stock:</span>
        <span id="product-stock">{{ product.stock|default:"0" }}</span>
    </p>
    <p class="text-gray-700 mb-1"><span class="font-semibold">Category:</span> {{ product.get_category_display }}</p>

    <!-- Edit/Delete (only for owner) -->
    {% if user == product.user %}
    <div class="mt-6 flex space-x-3">
        <button type="button" onclick="openModal()"
            class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">
            Edit
        </button>

        <form method="POST" action="{% url 'main:delete_product' product.id %}">
            {% csrf_token %}
            <button type="submit" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                Delete
            </button>
        </form>
    </div>
    {% endif %}

</div>

<!-- Edit Product Modal -->
<div id="product-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-lg">
        <h2 id="modal-title" class="text-xl font-bold mb-4">Edit Product</h2>
        <form id="modal-form" class="space-y-4">
            <label class="block font-semibold">Name</label>
            <input type="text" name="name" id="modal-name" value="{{ product.name }}"
                class="w-full border rounded px-2 py-1">

            <label class="block font-semibold">Description</label>
            <textarea name="description" id="modal-description"
                class="w-full border rounded px-2 py-1">{{ product.description }}</textarea>

            <label class="block font-semibold">Price</label>
            <input type="number" name="price" id="modal-price" value="{{ product.price }}"
                class="w-full border rounded px-2 py-1">

            <label class="block font-semibold">Category</label>
            <select name="category" id="modal-category" class="w-full border rounded px-2 py-1">
                <option value="shoes" {% if product.category is 'shoes' %}selected{% endif %}>Shoes</option>
                <option value="jersey" {% if product.category is 'jersey' %}selected{% endif %}>Jersey</option>
                <option value="ball" {% if product.category is 'ball' %}selected{% endif %}>Ball</option>
                <option value="accessories" {% if product.category is 'accessories' %}selected{% endif %}>Accessories
                </option>
            </select>

            <label class="block font-semibold">Brand</label>
            <input type="text" name="brand" id="modal-brand" value="{{ product.brand }}"
                class="w-full border rounded px-2 py-1">

            <label class="block font-semibold">Stock</label>
            <input type="number" name="stock" id="modal-stock" value="{{ product.stock }}"
                class="w-full border rounded px-2 py-1">

            <label class="block font-semibold">Thumbnail URL</label>
            <input type="url" name="thumbnail" id="modal-thumbnail" value="{{ product.thumbnail }}"
                class="w-full border rounded px-2 py-1">
        </form>
        <div class="mt-4 flex justify-end gap-2">
            <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
            <button type="button" onclick="submitEdit()" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
        </div>
    </div>
</div>

<script>
    function openModal() {
        document.getElementById('product-modal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('product-modal').classList.add('hidden');
    }

    async function submitEdit() {
        const form = document.getElementById('modal-form');
        const formData = new FormData(form);

        try {
            const res = await fetch(`/product/{{ product.id }}/edit/`, {
                method: "POST",
                headers: { "X-CSRFToken": getCookie("csrftoken") },
                body: formData
            });

            if (res.ok) {
                // Update detail page langsung dengan format yang benar
                document.getElementById('product-name').textContent = formData.get('name');
                document.getElementById('product-description').textContent = formData.get('description');

                const price = parseInt(formData.get('price'));
                document.getElementById('product-price').textContent = "Rp " + price.toLocaleString('id-ID');

                document.getElementById('product-brand').textContent = formData.get('brand') || '-';
                document.getElementById('product-stock').textContent = formData.get('stock') || '0';

                const thumbnailUrl = formData.get('thumbnail');
                const thumbElem = document.getElementById('product-thumbnail');
                if (thumbElem && thumbnailUrl) {
                    thumbElem.src = thumbnailUrl;
                }

                alert("Product updated!");
                closeModal();
            } else {
                const data = await res.json();
                console.error("Server error:", data);  // Debug
                alert(data.error || "Failed to update product");
            }
        } catch (err) {
            console.error("Request error:", err);  // Debug
            alert("Something went wrong");
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            document.cookie.split(";").forEach(cookie => {
                if (cookie.trim().startsWith(name + "=")) {
                    cookieValue = decodeURIComponent(cookie.trim().substring(name.length + 1));
                }
            });
        }
        return cookieValue;
    }
</script>
{% endblock %}